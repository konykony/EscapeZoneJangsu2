<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2ë²ˆ ë¬¸ì œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link href="../../css/common.css" rel="stylesheet" />
    <link href="../../css/alphabet5Unlock.css" rel="stylesheet" />
    <style>
        body {
            /* background-color: #f0f8ff; */
            /* text-align: center;
            font-family: 'Arial', sans-serif; */
        }

        .tool-btn {
            margin: 4px;
        }

        .tool-btn.active {
            border: 2px solid #93bef7;
        }

        .mirror-container {
            position: relative;
            width: 90vw;
            height: 60vh;
            max-width: 500px;
            margin: 10px auto;
            background-color: #aee1f9;
            border: 5px solid #aaa;
            border-radius: 10px;
            overflow: hidden;
        }

        #lock-container {
            width: 90vw;
            max-width: 500px;
            margin: 20px auto;
            padding: 0;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .overlay-text {
            font-size: 1.3rem;
            font-weight: bold;
            color: #555;
            margin-top: 0;
        }

        #steam-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #035fd6;
            font-weight: bold;
            display: none;
            text-align: center;
        }

        .cursor-tool {
            position: fixed;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 90;
            transform: translate(-50%, -50%);
            display: none;
        }

        #lock-container button {
            cursor: pointer;
            /* ê¸°ë³¸ í¬ì¸í„°(ì†ê°€ë½)ë¡œ ìœ ì§€ */
        }
    </style>
</head>

<body>
    <div id="game-container" class="container">
        <!-- í—¤ë” -->
        <div id="header"></div>
        <!-- í¼ì¦ ì˜ì—­ -->
        <div id="puzzle-text"></div>
        <div class="puzzle-area">
            <div class="overlay-text">ğŸª ê±°ìš¸ì„ ë‹¦ì•„ ì£¼ì„¸ìš”</div>

            <!-- ë„êµ¬ ì„ íƒ -->
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary tool-btn active" data-size="10" data-img="ğŸ–">ğŸ– ì†ë°”ë‹¥</button>
                <button class="btn btn-outline-primary tool-btn" data-size="25" data-img="ğŸ›">ğŸ› íƒ€ì˜¬</button>
                <button class="btn btn-outline-primary tool-btn" data-size="50" data-img="ğŸ§¼">ğŸ§¼ ìˆ˜ê±´</button>
            </div>

            <!-- ê±°ìš¸ ì˜ì—­ -->
            <div class="mirror-container">
                <canvas id="fog" width="500" height="60vh"></canvas>
                <div id="steam-message">ğŸ‰ STEAM!</div>
            </div>

            <!-- ë¸ŒëŸ¬ì‹œ ì•„ì´ì½˜ -->
            <div id="cursor" class="cursor-tool">ğŸ–</div>
        </div>
        <div class="footer-spacer"></div>
    </div>
    <!-- íŒíŠ¸ ëª¨ë‹¬ ì°½ -->
    <div id="hintModal"></div>
    <!-- lock ëª¨ë‹¬ ì°½-->
    <div id="lockModal"></div>

    <!-- í‘¸í„° -->
    <div id="footer"></div>
    <div id="exciting"></div>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery & Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>

    <script src="../../js/common.js"></script>
    <script src="../../js/cookieManage.js"></script>
    <script src="../../js/0515.js"></script>
    <script src="../../js/jsonManage.js"></script>
    <script src="../../js/playComm.js"></script>
    <script src="../../js/lock/alphabet5Unlock.js"></script>
    <script>

        const canvas = document.getElementById("fog");
        // const ctx = canvas.getContext("2d");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const steamMsg = document.getElementById("steam-message");
        const cursor = $("#cursor");
        let mirror = $(".mirror-container");
        var audio = new Audio('../../sound/glass_wipe_sound.wav'); // ì¬ìƒí•  ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        audio.loop = true;

        // ì‚¬ì´ì¦ˆ ì¡°ì •
        canvas.width = mirror.width();
        canvas.height = mirror.height();

        // ê¹€ì„œë¦¼ ì´ˆê¸°í™”
        ctx.fillStyle = "#cccccc";  // ì—°íšŒìƒ‰
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let drawing = false;
        let brushSize = 10;

        function updateBrushSize(size) {
            brushSize = parseInt(size);
        }

        $(".tool-btn").click(function () {
            $(".tool-btn").removeClass("active");
            $(this).addClass("active");
            updateBrushSize($(this).data("size"));
            cursor.text($(this).data("img"));
        });

        function getPos(e) {
            let rect = canvas.getBoundingClientRect();
            let x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            let y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            return { x, y };
        }

        function draw(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, brushSize, 0, Math.PI * 2);
            ctx.fillStyle = "#aee1f9";  // í•˜ëŠ˜ìƒ‰ (ë‹¦ì¸ í›„)
            ctx.fill();
        }

        function checkCleared() {
            let pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let cleared = 0;
            for (let i = 0; i < pixels.length; i += 4) {
                if (pixels[i] === 174 && pixels[i + 1] === 225 && pixels[i + 2] === 249) {
                    cleared++;
                }
            }
            let total = canvas.width * canvas.height;
            if (cleared / total > 0.9) {
                steamMsg.style.display = "block";
            }
        }

        function handleStart(e) {
            drawing = true;
            handleMove(e);
            // playGlassSound();
            $("#puzzle-text").hide();
            playSoundEffect('glass_wipe_sound.wav');
        }

        function handleMove(e) {
            if (!drawing) return;
            e.preventDefault();
            let pos = getPos(e);
            draw(pos.x, pos.y);
            checkCleared();
            cursor.css({ top: e.clientY || e.touches[0].clientY, left: e.clientX || e.touches[0].clientX });
        }

        function handleEnd() {
            drawing = false;
            // stopGlassSound();
            stopSoundEffect();
        }


        // ë¬¼ íŠ¸ëŠ” ì†Œë¦¬ on
        // function playGlassSound() {
        //     // 2. ì¬ìƒ ì‹œì‘
        //     audio.currentTime = 0;
        //     audio.play().then(() => {
        //         // ì¬ìƒì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•  ì½”ë“œ (ì„ íƒ ì‚¬í•­)
        //         console.log('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘!');
        //     }).catch((error) => {
        //         // ì¬ìƒì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰í•  ì½”ë“œ (ì£¼ë¡œ ìë™ ì¬ìƒ ì •ì±… ìœ„ë°˜)
        //         console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
        //         // ì‚¬ìš©ìì—ê²Œ ì¬ìƒ ë²„íŠ¼ì„ í‘œì‹œí•˜ê±°ë‚˜, ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        //     });
        // }
        // // ë¬¼ íŠ¸ëŠ” ì†Œë¦¬ off
        // function stopGlassSound() {
        //     audio.pause();        // ì¬ìƒì„ ì¼ì‹œì •ì§€
        //     audio.currentTime = 0; // ì¬ìƒ ìœ„ì¹˜ë¥¼ ì²˜ìŒ(0ì´ˆ)ìœ¼ë¡œ ì´ë™ = ì™„ì „ ì •ì§€
        // }

        function setSuccess() {
            setTimeout(() => {
                showExciting();
            }, 1000);
        }

        canvas.addEventListener("mousedown", handleStart, { passive: false })
        canvas.addEventListener("mousemove", handleMove);
        canvas.addEventListener("mouseup", handleEnd);
        canvas.addEventListener("mouseleave", handleEnd);

        canvas.addEventListener("touchstart", handleStart, { passive: false })
        canvas.addEventListener("touchmove", handleMove);
        canvas.addEventListener("touchend", handleEnd);

        // // ë§ˆìš°ìŠ¤ ë”°ë¼ë‹¤ë‹ˆëŠ” ì»¤ì„œ
        // $(document).on("mousemove touchmove", function (e) {
        //     let x = e.clientX || (e.touches && e.touches[0].clientX);
        //     let y = e.clientY || (e.touches && e.touches[0].clientY);
        //     cursor.css({ top: y, left: x }).show();
        // });

        // ë§ˆìš°ìŠ¤/í„°ì¹˜ê°€ ê±°ìš¸ ìœ„ì— ìˆì„ ë•Œë§Œ ë„êµ¬ ì»¤ì„œ í‘œì‹œ
        $(".mirror-container").on("mousemove touchmove", function (e) {
            let x = e.clientX || (e.touches && e.touches[0].clientX);
            let y = e.clientY || (e.touches && e.touches[0].clientY);
            cursor.css({ top: y, left: x }).show();
        });

        // ê±°ìš¸ì—ì„œ ë²—ì–´ë‚˜ë©´ ìˆ¨ê¹€
        $(".mirror-container").on("mouseleave touchend", function () {
            cursor.hide();
        });

        $(document).on("touchend mouseleave", function () {
            cursor.hide();
        });

        $(document).ready(function () {
            createArrowLockGame("steam", "#lockModal");
            // $('.mirror-container').on("click", function (e) {
            //     $("#puzzle-text").hide();
            // });
        });

    </script>
</body>
</html>
