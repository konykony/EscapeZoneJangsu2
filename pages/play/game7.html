<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>7Î≤à Î¨∏Ï†ú</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link href="../../css/common.css" rel="stylesheet" />
    <style>
        .stage {
            display: none;
        }

        .active {
            display: block;
        }

        #ingredients {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            padding: 1rem;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            overflow-x: hidden;
        }

        .ingredient-item {
            width: 70px;
            height: 70px;
            line-height: 70px;
            text-align: center;
            font-weight: bold;
            cursor: grab;
            user-select: none;
            position: relative;
            z-index: 10;
            font-size: 1.2rem;
        }

        .square {
            border-radius: .25rem;
        }

        .circle {
            border-radius: 50%;
        }

        .bread {
            background: #f5deb3;
            border: 2px solid #d2b48c
        }

        .bacon {
            background: #ffc0cb;
            border: 2px solid #ff69b4
        }

        .onion {
            background: #ffffff;
            border: 2px solid #ccc
        }

        .egg {
            background: #fff5b7;
            border: 2px solid #f0e68c
        }

        .tomato {
            background: #ff6347;
            border: 2px solid #cd3131
        }

        .cheese {
            background: #ffeb3b;
            border: 2px solid #e6c200
        }

        .lettuce {
            background: #98fb98;
            border: 2px solid #5cad5c
        }

        .sauce {
            background: #d2691e;
            border: 2px solid #a0522d
        }

        #grill-area {
            position: relative;
            /* height: 150px; */
            height: 120px;
            margin: 1rem 0;
            background: #dedede;
            border: 2px dashed #aaa;
        }

        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888;
            z-index: 1;
        }

        .grilled-item {
            position: absolute;
            width: 70px;
            height: 70px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 20;
            font-weight: bold;
            color: #333;
            transition: filter .1s;
            font-size: 1.2rem;
        }

        #progress-container {
            display: none;
        }

        #grill-bar {
            background: #0d6efd;
            transition: width .1s;
        }

        #results {
            margin-top: 1rem;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            padding: .5rem;
        }

        .result-entry {
            display: flex;
            align-items: center;
            margin-bottom: .25rem;
        }

        .result-entry .check {
            color: #28a745;
            margin-left: .5rem;
        }

        .result-entry button {
            margin-left: auto;
        }
        .form-label{
            font-size: 1rem;
            display: none;
        }
        .puzzle-area{
            font-size: 1.2rem;
            /* overflow-y: auto;
            max-height: 100%; */
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Ìó§Îçî -->
        <div id="header"></div>
        <!-- ÌçºÏ¶ê ÏòÅÏó≠ -->
        <div id="puzzle-text"></div>
        <div class="puzzle-area">
            <!-- Stage 1 -->
            <div id="stage1" class="stage active mt-3">
                <h4>1Îã®Í≥Ñ: Ïû¨Î£å ÍµΩÍ∏∞</h4>
                <label class="form-label">ÍµΩÍ∏∞ ÏÜçÎèÑ (20=ÎäêÎ¶º ‚Üî 100=Îπ†Î¶Ñ)
                    <input id="speedRange" type="range" min="20" max="100" value="40" class="form-range">
                </label>
                <div id="ingredients"></div>
                <div id="grill-area">
                    <div class="placeholder">Ïó¨Í∏∞Ïóê Ïû¨Î£åÎ•º Ïò¨Î†§Ï£ºÏÑ∏Ïöî</div>
                </div>
                <div id="progress-container">
                    <div class="progress-gril">
                        <div id="grill-bar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
                    </div>
                    <button id="stop-btn" class="btn btn-warning btn mt-2">Í∑∏Îßå ÍµΩÍ∏∞</button>
                    <button id="retry-btn" class="btn btn-secondary btn mt-2">Ïû¨ÏãúÎèÑ</button>
                </div>
                <div id="results"></div>
                <div class="text-center mt-3">
                    <button id="toStage2" class="btn btn-primary" disabled>Îã§Ïùå</button>
                </div>
            </div>

            <!-- Stage 2 -->
            <div id="stage2" class="stage mt-3">
                <h4>2Îã®Í≥Ñ: Ïû¨Î£å Ï°∞Ìï©</h4>
                <ul id="stack-area" class="list-group mb-3"></ul>
                <div class="text-center">
                    <!-- <button id="checkRecipe" class="btn btn-success">ÌôïÏù∏</button> -->
                    <button id="btnNext" class="btn btn-success">Îã§Ïùå</button>
                    <button id="retryStage2" class="btn btn-secondary">Ïû¨ÏãúÎèÑ</button>
                </div>
                <div id="finalResult" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>
    <!-- ÌûåÌä∏ Î™®Îã¨ Ï∞Ω -->
    <div id="hintModal"></div>
    <!-- lock Î™®Îã¨ Ï∞Ω-->
    <!-- <div id="lockModal"></div> -->

    <!-- Ìë∏ÌÑ∞ -->
    <div id="footer"></div>
    <div id="exciting"></div>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery & Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <script src="../../js/common.js"></script>
    <script src="../../js/cookieManage.js"></script>
    <script src="../../js/0515.js"></script>
    <script src="../../js/jsonManage.js"></script>
    <script src="../../js/playComm.js"></script>
    <script>

        let audio = new Audio('../../sound/grilling3.mp3');;
        function playGrillAudio(){
            // 2. Ïû¨ÏÉù ÏãúÏûë
            audio.play().then(() => {
                console.log('Ïò§ÎîîÏò§ Ïû¨ÏÉù ÏãúÏûë!');
            }).catch((error) => {
                console.error('Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïã§Ìå®:', error);
            });
        }

        function stopGrillAudio(){
            if(audio != null){
                audio.pause();        // Ïû¨ÏÉùÏùÑ ÏùºÏãúÏ†ïÏßÄ
                audio.currentTime = 0; // Ïû¨ÏÉù ÏúÑÏπòÎ•º Ï≤òÏùå(0Ï¥à)ÏúºÎ°ú Ïù¥Îèô = ÏôÑÏ†Ñ Ï†ïÏßÄ
            }
        }

        $(function () {
            const grillItems = [
                { key: 'bacon', name: 'Î≤†Ïù¥Ïª®', target: 80, shape: 'square' },
                { key: 'bread', name: 'ÏãùÎπµ', target: 70, shape: 'square' },
                { key: 'egg', name: 'Í≥ÑÎûÄ', target: 60, shape: 'circle' },  // Î≥ÄÍ≤Ω: 100‚Üí60
                { key: 'onion', name: 'ÏñëÌåå', target: 50, shape: 'circle' },
                { key: 'tomato', name: 'ÌÜ†ÎßàÌÜ†', target: 40, shape: 'circle' },
                // { key: 'cheese', name: 'ÏπòÏ¶à', target: null, shape: 'square' },
                // { key: 'lettuce', name: 'ÏñëÏÉÅÏ∂î', target: null, shape: 'circle' },
                // { key: 'sauce', name: 'ÏÜåÏä§', target: null, shape: 'square' }
            ];
            const order = ['ÏãùÎπµ', 'Î≤†Ïù¥Ïª®', 'Í≥ÑÎûÄ', 'ÏñëÌåå', 'ÌÜ†ÎßàÌÜ†', 'ÏπòÏ¶à', 'ÏñëÏÉÅÏ∂î', 'ÏÜåÏä§', 'ÏãùÎπµ'];
            let processed = 0, successCount = 0, current = null, timer;

            function grillInterval() {
                const speedVal = +$('#speedRange').val();
                // interval = 100 - speedVal
                return Math.max(5, 100 - speedVal);
            }

            // render cards
            grillItems.forEach(i => {
                $('<div>')
                    .addClass(`ingredient-item ${i.shape} ${i.key}`)
                    .text(i.name)
                    .appendTo('#ingredients')
                    .draggable({
                        helper: 'clone', revert: 'invalid',
                        containment: 'body', appendTo: 'body', zIndex: 1000
                    });
            });

            $('#grill-area').droppable({
                accept: '.ingredient-item',
                drop(_, ui) {
                    if (current) return;
                    const name = ui.draggable.text();
                    const cfg = grillItems.find(x => x.name === name);
                    ui.draggable.remove();
                    $('.placeholder').hide();
                    $('.grilled-item').remove();
                    $('<div>')
                        .addClass(`grilled-item ${cfg.shape} ${cfg.key}`)
                        .text(cfg.name)
                        .appendTo('#grill-area');
                    if (cfg.target === null) {
                        record(cfg.name, null, true);
                    } else {
                        current = cfg;
                        $('#progress-container').show();
                        updateProgress(0);
                        startGrill();
                    }
                }
            });

            function startGrill() {
                let v = 0;
                clearInterval(timer);
                playGrillAudio();
                timer = setInterval(() => {
                    v = Math.min(100, v + 1);
                    updateProgress(v);
                    // brightness calc
                    let brightness;
                    if (v <= 80) {
                        brightness = 1 - (v / 100) / 3;
                    } else {
                        brightness = 0.7333 * (1 - (v - 80) / 20);
                    }
                    $('.grilled-item').css('filter', `brightness(${brightness})`);
                    if (v >= 100) {
                        clearInterval(timer);
                        stopGrillAudio();
                    }
                }, grillInterval());
            }

            function updateProgress(v) {
                $('#grill-bar').css('width', v + '%').text(v + '%');
            }

            $('#stop-btn').click(() => {
                clearInterval(timer);
                stopGrillAudio();
                const v = parseInt($('#grill-bar').text());
                record(current.name, v, false);
            });
            $('#retry-btn').click(() => {
                clearInterval(timer);
                stopGrillAudio();
                updateProgress(0);
                startGrill();
            });

            function record(name, val, auto) {
                const cfg = grillItems.find(x => x.name === name);
                const ok = cfg.target === null || auto || Math.abs(val - cfg.target) <= 5;
                if (ok) successCount++;
                const $entry = $('<div class="result-entry">').text(
                    `${name}: ${cfg.target === null ? 'ÏÉùÏû¨Î£å' : val + '%'}`
                );
                if (ok) {
                    $entry.append('<span class="check">‚úîÔ∏è</span>');
                } else {
                    $('<button class="btn btn-link btn">Îã§Ïãú ÍµΩÍ∏∞</button>')
                        .appendTo($entry)
                        .click(() => {
                            // remove from grill and results
                            $('.grilled-item.' + cfg.key).remove();
                            $entry.remove();
                            processed--;
                            // re-add card
                            $('<div>')
                                .addClass(`ingredient-item ${cfg.shape} ${cfg.key}`)
                                .text(cfg.name)
                                .appendTo('#ingredients')
                                .draggable({
                                    helper: 'clone', revert: 'invalid',
                                    containment: 'body', appendTo: 'body', zIndex: 1000
                                });
                        });
                }
                $('#results').append($entry);
                processed++; current = null;
                $('#progress-container').hide();
                $('.placeholder').toggle(processed < grillItems.length);
                if (processed === grillItems.length && successCount === grillItems.length) {
                    $('#toStage2').prop('disabled', false);
                }
            }

            $('#toStage2').click(() => {
                // $('#stack-area').sortable();
                $('#stack-area').sortable({
                    stop: function( event, ui ) {
                        checkToast();
                    }
                });
                $('#stage1').removeClass('active');
                $('#stage2').addClass('active');
                // const shuffled = [...order].sort(() => Math.random() - 0.5);
                const shuffled = shuffleArray([...order]);
                // foreach Ïã§Ìñâ
                shuffled.forEach(name => {
                    $('#stack-area').append(
                        $('<li>').addClass('list-group-item').text(name)
                    );
                });
                
                //   order.forEach(name=>{
                //     $('#stack-area').append(
                //       $('<li>').addClass('list-group-item').text(name)
                //     );
                //   });
                // $('#stack-area').sortable();
            });
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]]; // ES6 Íµ¨Ï°∞ Î∂ÑÌï¥ Ìï†ÎãπÏùÑ Ïù¥Ïö©Ìïú swap
                }
                return array;
            }
            $('#checkRecipe').click(() => {
                const user = $('#stack-area li').map((_, li) => $(li).text()).get();
                const ok = user.every((v, i) => v === order[i]);
                if(ok){
                    setTimeout(() => {
                        showExciting();
                    }, 1000);
                }
                $('#finalResult')
                    .text(ok ? 'ü•≥ ÏôÑÎ≤ΩÌïú ÌÜ†Ïä§Ìä∏!' : 'üòÖ ÏàúÏÑúÍ∞Ä ÌãÄÎ†∏Ïñ¥Ïöî!')
                    .toggleClass('text-success', ok)
                    .toggleClass('text-danger', !ok);
            });
            // $('#retryStage2').click(() => location.reload());
            $('#retryStage2').click(()=>{
                // clear only stage2
                $('#stack-area').empty();
                $('#finalResult').empty();
                const shuffled = [...order].sort(() => Math.random() - 0.5);
                shuffled.forEach(name=>{
                    $('#stack-area').append(
                    $('<li>').addClass('list-group-item').text(name)
                    );
                });
                $('#stack-area').sortable({
                    stop: function( event, ui ) {
                        checkToast();
                    }
                });
            });

            $('#btnNext').click(()=>{
                setTimeout(() => {
                    showExciting();
                }, 100);
            });

            $('#btnNext').hide();
            
            function checkToast(){
                playAudio('jump09.mp3');
                const user = $('#stack-area li').map((_, li) => $(li).text()).get();
                const ok = user.every((v, i) => v === order[i]);
                if(ok){
                    $('#finalResult')
                    .text('ü•≥ ÏôÑÎ≤ΩÌïú ÌÜ†Ïä§Ìä∏!')
                    .toggleClass('text-success', ok);
                    $('#btnNext').show();
                    $('#stack-area').sortable('disable');
                    playAudio('success.mp3');
                    // setTimeout(() => {
                    //     showExciting();
                    // }, 1000);
                }
                // $('#finalResult')
                //     .text(ok ? 'ü•≥ ÏôÑÎ≤ΩÌïú ÌÜ†Ïä§Ìä∏!' : 'üòÖ ÏàúÏÑúÍ∞Ä ÌãÄÎ†∏Ïñ¥Ïöî!')
                //     .toggleClass('text-success', ok)
                //     .toggleClass('text-danger', !ok);
            }
        });
    </script>
</body>

</html>